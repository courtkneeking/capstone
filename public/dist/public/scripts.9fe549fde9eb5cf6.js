"use strict";!function(L){angular.module("pw.canvas-painter",[]),function(n){try{n=angular.module("pw.canvas-painter")}catch(l){n=angular.module("pw.canvas-painter",[])}n.run(["$templateCache",function(l){l.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(n){try{n=angular.module("pw.canvas-painter")}catch(l){n=angular.module("pw.canvas-painter",[])}n.run(["$templateCache",function(l){l.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",function(){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(n,l){var v="ontouchstart"in L,k=v?"touchstart":"mousedown",w=v?"touchmove":"mousemove",S=v?"touchend":"mouseup",e=n.options;if(e.canvasId=e.customCanvasId||"pwCanvasMain",e.tmpCanvasId=e.customCanvasId?e.canvasId+"Tmp":"pwCanvasTmp",e.width=e.width||400,e.height=e.height||300,e.backgroundColor=e.backgroundColor||"#fff",e.color=e.color||"#000",e.undoEnabled=e.undoEnabled||!1,e.opacity=e.opacity||.9,e.lineWidth=e.lineWidth||1,e.undo=e.undo||!1,e.imageSrc=e.imageSrc||!1,e.imageSrc){var C=new Image;C.onload=function(){p.drawImage(this,0,0)},C.src=e.imageSrc}if(e.undo){var s=[];n.$watch(function(){return s.length},function(t){n.version=t}),n.$watch("version",function(t){return 0>t?void(n.version=0):t>=s.length?void(n.version=s.length):void T(t)})}var u=document.createElement("canvas");u.id=e.canvasId;var a=document.createElement("canvas");a.id=e.tmpCanvasId,angular.element(a).css({position:"absolute",top:0,left:0}),l.find("div").append(u),l.find("div").append(a);var p=u.getContext("2d"),o=a.getContext("2d"),d={x:0,y:0},i=[];u.width=a.width=e.width,u.height=a.height=e.height,p.fillStyle=e.backgroundColor,p.fillRect(0,0,u.width,u.height),o.globalAlpha=e.opacity,o.lineJoin=o.lineCap="round",o.lineWidth=10,o.strokeStyle=e.color,n.$watch("options.lineWidth",function(t){"string"==typeof t&&(t=parseInt(t,10)),t&&"number"==typeof t&&(o.lineWidth=e.lineWidth=t)}),n.$watch("options.color",function(t){t&&(o.strokeStyle=o.fillStyle=t)}),n.$watch("options.opacity",function(t){t&&(o.globalAlpha=t)});var x=function(t){var r=t.getBoundingClientRect();return{left:r.left,top:r.top}},b=function(t,r){v?(t.x=r.changedTouches[0].pageX-x(r.target).left,t.y=r.changedTouches[0].pageY-x(r.target).top):(t.x=void 0!==r.offsetX?r.offsetX:r.layerX,t.y=void 0!==r.offsetY?r.offsetY:r.layerY)},f=function(t){if(t&&(t.preventDefault(),b(d,t)),i.push({x:d.x,y:d.y}),3===i.length){var r=i[0];return o.beginPath(),o.arc(r.x,r.y,o.lineWidth/2,0,2*Math.PI,!0),o.fill(),void o.closePath()}o.clearRect(0,0,a.width,a.height),o.beginPath(),o.moveTo(i[0].x,i[0].y);for(var c=1;c<i.length-2;c++)o.quadraticCurveTo(i[c].x,i[c].y,(i[c].x+i[c+1].x)/2,(i[c].y+i[c+1].y)/2);o.quadraticCurveTo(i[c].x,i[c].y,i[c+1].x,i[c+1].y),o.stroke()},E=function(){e.undo&&n.$apply(function(){s.push(p.getImageData(0,0,a.width,a.height)),angular.isNumber(e.undo)&&e.undo>0&&(s=s.slice(-1*e.undo))}),a.removeEventListener(w,f,!1),p.drawImage(a,0,0),o.clearRect(0,0,a.width,a.height),i=[]},I=function(t){t.preventDefault(),a.addEventListener(w,f,!1),b(d,t),i.push({x:d.x,y:d.y}),i.push({x:d.x,y:d.y}),f()},T=function(t){s.length>0&&(p.putImageData(s[t],0,0),s=s.slice(0,t))};!function(){function t(){h=!0}function r(){h=!1}var h;a.addEventListener(k,I,!1),a.addEventListener(S,E,!1),v||(document.body.addEventListener("mousedown",t),document.body.addEventListener("mouseup",r),n.$on("$destroy",function c(){document.body.removeEventListener("mousedown",t),document.body.removeEventListener("mouseup",r)}),a.addEventListener("mouseenter",function m(y){h&&I(y)}),a.addEventListener("mouseleave",function g(y){h&&E()}))}()}}}),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(n){n.setColor=function(l){n.selectedColor=l}}}})}(this);